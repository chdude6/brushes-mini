<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Crucial for mobile-first design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brushes - Mobile Photo Editor</title>
    <meta name="description" content="A mobile-focused photo editing suite with advanced brushes and tools.">
    <!-- Using Google Fonts for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2c2c2c;
            --bg-tertiary: #404040;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --accent-blue: #007aff;
            --accent-orange: #ff9500;
            --border-color: #4a4a4a;
            --hover-color: #555555;
            --canvas-bg: repeating-conic-gradient(#333 0% 25%, #444 0% 50%) 50% / 20px 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent scrolling of the whole page */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Top Bar */
        .top-bar {
            height: 50px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 18px;
        }

        .top-bar-actions button {
            background: none;
            border: none;
            color: var(--accent-blue);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px;
        }
        
        /* Main Workspace */
        .workspace {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--canvas-bg);
            position: relative;
            overflow: auto; /* Enable pinch-zoom and panning */
            -webkit-overflow-scrolling: touch;
        }

        .canvas-wrapper {
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        #main-canvas {
            background: white;
            display: block;
            touch-action: none; /* Allows us to handle touch events for drawing */
        }

        /* Bottom Toolbar - Main Navigation for mobile */
        .bottom-toolbar {
            height: 70px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        }

        .tool-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
            width: 60px;
        }
        
        .tool-button.active {
            color: var(--accent-blue);
        }

        .tool-button .icon {
            font-size: 24px;
        }

        /* Slide-in Panels */
        .slide-panel {
            position: fixed;
            bottom: 70px; /* Start above the toolbar */
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* For iPhone X notch */
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            max-height: 50vh;
            overflow-y: auto;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }

        .slide-panel.show {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-panel-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Brush Panel Styles */
        .brush-preview-mobile {
            width: 100%;
            height: 100px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-circle {
            border-radius: 50%;
        }

        /* Sliders for Mobile */
        .slider-group {
            margin-bottom: 16px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            border: 4px solid var(--accent-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        /* Tools Panel Styles */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 16px;
        }

        .grid-tool-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            height: 70px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .grid-tool-btn .icon {
            font-size: 22px;
        }

        .grid-tool-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Layers Panel Styles */
        .layer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.15s;
        }

        .layer-item.active {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px var(--accent-blue);
        }
        
        .layer-visibility { font-size: 20px; cursor: pointer; }
        .layer-name { flex: 1; font-size: 14px; }

        .layer-controls {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .layer-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Color Picker */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 16px;
            justify-content: center;
        }
        .color-well {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--border-color);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(5px);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            animation: fadeInOut 3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, 10px); }
            10%, 90% { opacity: 1; transform: translate(-50%, 0); }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo">Brushes</div>
            <div class="top-bar-actions">
                <button onclick="editor.saveFile()">Save</button>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="workspace">
            <div class="canvas-wrapper">
                <canvas id="main-canvas" width="800" height="600"></canvas>
            </div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="bottom-toolbar">
            <button class="tool-button" data-panel="tools">
                <span class="icon">üñåÔ∏è</span>
                <span>Tools</span>
            </button>
            <button class="tool-button active" data-panel="brush-settings">
                <span class="icon">‚ú®</span>
                <span>Brush</span>
            </button>
            <button class="tool-button" onclick="editor.pickColor('foreground')">
                <span id="color-swatch" class="icon" style="color: black;">‚ö´</span>
                <span>Color</span>
            </button>
            <button class="tool-button" data-panel="layers">
                <span class="icon">Í≤π</span> <!-- Unicode for layers -->
                <span>Layers</span>
            </button>
            <button class="tool-button" onclick="editor.undo()">
                <span class="icon">‚Ü∂</span>
                <span>Undo</span>
            </button>
        </div>

        <!-- Panels -->
        <!-- Brush Settings Panel -->
        <div id="brush-settings-panel" class="slide-panel">
            <div class="panel-header">
                <h2 class="panel-title">Brush Settings</h2>
                <button class="close-panel-btn" data-panel="brush-settings">√ó</button>
            </div>
            <div class="brush-preview-mobile">
                <div class="brush-circle" id="brush-preview"></div>
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Size</span><span id="size-value">20</span></div>
                <input type="range" class="slider" id="brush-size" min="1" max="300" value="20">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Hardness</span><span id="hardness-value">100%</span></div>
                <input type="range" class="slider" id="brush-hardness" min="0" max="100" value="100">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Opacity</span><span id="opacity-value">100%</span></div>
                <input type="range" class="slider" id="brush-opacity" min="1" max="100" value="100">
            </div>
        </div>
        
        <!-- Tools Panel -->
        <div id="tools-panel" class="slide-panel">
            <div class="panel-header">
                <h2 class="panel-title">Tools</h2>
                <button class="close-panel-btn" data-panel="tools">√ó</button>
            </div>
            <div class="tools-grid">
                <button class="grid-tool-btn active" data-tool="brush"><span class="icon">üñåÔ∏è</span>Brush</button>
                <button class="grid-tool-btn" data-tool="eraser"><span class="icon">üßπ</span>Eraser</button>
                <button class="grid-tool-btn" data-tool="move"><span class="icon">‚úã</span>Move</button>
                <button class="grid-tool-btn" data-tool="eyedropper"><span class="icon">üíß</span>Picker</button>
                <button class="grid-tool-btn" data-tool="healing"><span class="icon">ü©π</span>Heal</button>
                <button class="grid-tool-btn" data-tool="blur"><span class="icon">üå´Ô∏è</span>Blur</button>
            </div>
        </div>

        <!-- Layers Panel -->
        <div id="layers-panel" class="slide-panel">
            <div class="panel-header">
                <h2 class="panel-title">Layers</h2>
                <button class="close-panel-btn" data-panel="layers">√ó</button>
            </div>
            <div id="layers-list"></div>
            <div class="layer-controls">
                <button class="layer-btn" onclick="editor.addLayer()">+ Add</button>
                <button class="layer-btn" onclick="editor.deleteLayer()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        class BrushesEditor {
            constructor() {
                this.state = {
                    currentTool: 'brush',
                    brushSettings: { size: 20, hardness: 100, opacity: 100 },
                    colors: { foreground: '#000000', background: '#ffffff' },
                    layers: [],
                    currentLayerId: null,
                    isDrawing: false,
                    lastPoint: null,
                    history: [],
                    historyIndex: -1,
                };

                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.activePanel = 'brush-settings';
                
                this.initializeEditor();
            }

            initializeEditor() {
                this.resizeCanvas();
                this.createInitialLayer();
                this.initializeEventListeners();
                this.updateUI();
                this.updateLayersUI();
                this.redrawCanvas();
                this.saveToHistory('New Document');
                this.togglePanel('brush-settings', true); // Show brush settings by default
            }
            
            resizeCanvas() {
                const workspace = document.querySelector('.workspace');
                const dpr = window.devicePixelRatio || 1;
                // Set a max size for performance, but allow it to be smaller
                const maxWidth = 1024;
                const maxHeight = 1024;
                
                const newWidth = Math.min(workspace.clientWidth * 0.9, maxWidth);
                const newHeight = Math.min(workspace.clientHeight * 0.9, maxHeight);

                this.canvas.style.width = `${newWidth}px`;
                this.canvas.style.height = `${newHeight}px`;

                this.canvas.width = newWidth * dpr;
                this.canvas.height = newHeight * dpr;
                
                this.ctx.scale(dpr, dpr);
            }

            createInitialLayer() {
                const canvas = document.createElement('canvas');
                canvas.width = this.canvas.width;
                canvas.height = this.canvas.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const layer = { id: 'background', name: 'Background', visible: true, canvas: canvas };
                this.state.layers.push(layer);
                this.state.currentLayerId = layer.id;
            }

            initializeEventListeners() {
                // Touch events for drawing
                this.canvas.addEventListener('touchstart', (e) => this.handleMouseDown(e), { passive: false });
                this.canvas.addEventListener('touchmove', (e) => this.handleMouseMove(e), { passive: false });
                this.canvas.addEventListener('touchend', () => this.handleMouseUp());
                
                // Mouse events for desktop fallback
                this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseup', () => this.handleMouseUp());

                // Panel toggles
                document.querySelectorAll('[data-panel]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.togglePanel(btn.dataset.panel);
                    });
                });

                // Tool selection from grid
                document.querySelectorAll('.grid-tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.selectTool(btn.dataset.tool);
                        this.togglePanel('tools', false);
                    });
                });

                // Brush settings
                this.setupSliderEvents();
            }
            
            togglePanel(panelId, forceShow = null) {
                const panel = document.getElementById(`${panelId}-panel`);
                const button = document.querySelector(`.tool-button[data-panel="${panelId}"]`);

                const shouldShow = forceShow !== null ? forceShow : !panel.classList.contains('show');

                // Hide all other panels
                document.querySelectorAll('.slide-panel.show').forEach(p => p.classList.remove('show'));
                document.querySelectorAll('.tool-button.active').forEach(b => b.classList.remove('active'));

                if (shouldShow) {
                    panel.classList.add('show');
                    if (button) button.classList.add('active');
                    this.activePanel = panelId;
                } else {
                    this.activePanel = null;
                }
            }

            setupSliderEvents() {
                ['brush-size', 'brush-hardness', 'brush-opacity'].forEach(id => {
                    const slider = document.getElementById(id);
                    if (slider) {
                        slider.addEventListener('input', (e) => {
                            const property = id.split('-')[1];
                            this.state.brushSettings[property] = parseInt(e.target.value);
                            this.updateUI();
                        });
                    }
                });
            }

            selectTool(tool) {
                this.state.currentTool = tool;
                document.querySelectorAll('.grid-tool-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tool === tool);
                });
                this.showToast(`${tool.charAt(0).toUpperCase() + tool.slice(1)} Tool`);
            }
            
            getEventPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                // Handle touch vs mouse
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                // Adjust for canvas scaling and DPR
                const scaleX = this.canvas.width / dpr / rect.width;
                const scaleY = this.canvas.height / dpr / rect.height;

                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY,
                };
            }

            handleMouseDown(e) {
                e.preventDefault();
                const point = this.getEventPos(e);
                this.isDrawing = true;
                this.lastPoint = point;

                const currentLayer = this.getCurrentLayer();
                if (!currentLayer) return;

                this.saveToHistory(`${this.state.currentTool} stroke`);
                this.executeToolDown(point);
                this.redrawCanvas();
            }

            handleMouseMove(e) {
                if (!this.isDrawing) return;
                e.preventDefault();
                const point = this.getEventPos(e);
                const currentLayer = this.getCurrentLayer();
                if (!currentLayer) return;

                this.executeToolMove(point);

                this.lastPoint = point;
                // Redraw frequently for responsiveness
                requestAnimationFrame(() => this.redrawCanvas());
            }

            handleMouseUp() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.lastPoint = null;
                }
            }
            
            executeToolDown(point) {
                 switch (this.state.currentTool) {
                    case 'brush':
                    case 'eraser':
                        this.startPaintStroke(point);
                        break;
                    case 'eyedropper':
                        this.pickColorFromCanvas(point);
                        break;
                }
            }

            executeToolMove(point) {
                switch (this.state.currentTool) {
                    case 'brush':
                    case 'eraser':
                        this.continuePaintStroke(point);
                        break;
                }
            }
            
            startPaintStroke(point) {
                const currentLayer = this.getCurrentLayer();
                const ctx = currentLayer.canvas.getContext('2d');
                
                ctx.globalCompositeOperation = this.state.currentTool === 'eraser' ? 'destination-out' : 'source-over';
                
                this.drawBrushLine(ctx, point, point);
            }

            continuePaintStroke(point) {
                if (!this.lastPoint) return;
                
                const currentLayer = this.getCurrentLayer();
                const ctx = currentLayer.canvas.getContext('2d');
                
                this.drawBrushLine(ctx, this.lastPoint, point);
            }

            drawBrushLine(ctx, from, to) {
                const { size, hardness, opacity } = this.state.brushSettings;
                
                ctx.lineWidth = size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                const color = this.state.colors.foreground;
                const hardnessFactor = hardness / 100;
                
                // For soft brushes, we create a gradient
                if (hardnessFactor < 1.0) {
                    const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, size / 2);
                    const rgbaColor = this.hexToRgba(color, opacity / 100);
                    grad.addColorStop(0, rgbaColor);
                    grad.addColorStop(hardnessFactor, rgbaColor);
                    grad.addColorStop(1, this.hexToRgba(color, 0));
                    ctx.fillStyle = grad;
                } else {
                    ctx.fillStyle = this.hexToRgba(color, opacity / 100);
                }

                // Interpolate points for a smooth line
                const dist = Math.hypot(to.x - from.x, to.y - from.y);
                const steps = Math.max(1, Math.floor(dist / (size / 4)));

                for (let i = 0; i < steps; i++) {
                    const t = i / steps;
                    const x = from.x + (to.x - from.x) * t;
                    const y = from.y + (to.y - from.y) * t;

                    ctx.save();
                    ctx.translate(x, y);
                    ctx.beginPath();
                    ctx.arc(0, 0, size / 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }

            pickColorFromCanvas(point) {
                const dpr = window.devicePixelRatio || 1;
                const currentLayer = this.getCurrentLayer();
                if (!currentLayer) return;
                
                const ctx = currentLayer.canvas.getContext('2d');
                const pixelData = ctx.getImageData(point.x * dpr, point.y * dpr, 1, 1).data;
                const color = this.rgbaToHex(pixelData[0], pixelData[1], pixelData[2]);
                
                this.state.colors.foreground = color;
                this.updateUI();
                this.showToast(`Color picked: ${color}`);
            }


            // Layer management
            getCurrentLayer() {
                return this.state.layers.find(l => l.id === this.state.currentLayerId);
            }

            addLayer() {
                const canvas = document.createElement('canvas');
                canvas.width = this.canvas.width;
                canvas.height = this.canvas.height;
                
                const newLayer = { id: `layer-${Date.now()}`, name: `Layer ${this.state.layers.length}`, visible: true, canvas: canvas };

                this.state.layers.push(newLayer);
                this.state.currentLayerId = newLayer.id;
                this.updateLayersUI();
                this.saveToHistory('Add Layer');
            }

            deleteLayer() {
                if (this.state.layers.length <= 1) {
                    this.showToast('Cannot delete last layer');
                    return;
                }
                this.state.layers = this.state.layers.filter(l => l.id !== this.state.currentLayerId);
                this.state.currentLayerId = this.state.layers[this.state.layers.length - 1].id;
                this.updateLayersUI();
                this.redrawCanvas();
                this.saveToHistory('Delete Layer');
            }

            // File operations
            saveFile() {
                const link = document.createElement('a');
                link.download = 'brushes-mobile-art.png';
                link.href = this.canvas.toDataURL('image/png');
                link.click();
                this.showToast('Image saved');
            }

            // Color operations
            pickColor(type) {
                const input = document.createElement('input');
                input.type = 'color';
                input.value = this.state.colors[type];
                input.onchange = (e) => {
                    this.state.colors[type] = e.target.value;
                    this.updateUI();
                };
                input.click();
            }

            // History management
            saveToHistory(action) {
                const currentLayer = this.getCurrentLayer();
                if (!currentLayer) return;
                const imageData = currentLayer.canvas.getContext('2d').getImageData(0, 0, currentLayer.canvas.width, currentLayer.canvas.height);
                this.state.history = this.state.history.slice(0, this.state.historyIndex + 1);
                this.state.history.push({ action: action, layerId: this.state.currentLayerId, imageData: imageData });
                if (this.state.history.length > 30) this.state.history.shift();
                this.state.historyIndex = this.state.history.length - 1;
            }

            undo() {
                if (this.state.historyIndex > 0) {
                    this.state.historyIndex--;
                    const entry = this.state.history[this.state.historyIndex];
                    const layer = this.state.layers.find(l => l.id === entry.layerId);
                    if (layer) {
                        layer.canvas.getContext('2d').putImageData(entry.imageData, 0, 0);
                        this.redrawCanvas();
                        this.showToast(`Undo: ${entry.action}`);
                    }
                } else {
                    this.showToast('Nothing to undo');
                }
            }

            // UI Updates
            updateUI() {
                document.getElementById('color-swatch').style.color = this.state.colors.foreground;
                document.getElementById('size-value').textContent = this.state.brushSettings.size;
                document.getElementById('hardness-value').textContent = this.state.brushSettings.hardness + '%';
                document.getElementById('opacity-value').textContent = this.state.brushSettings.opacity + '%';
                this.updateBrushPreview();
            }

            updateBrushPreview() {
                const preview = document.getElementById('brush-preview');
                const size = Math.min(60, this.state.brushSettings.size);
                const hardness = this.state.brushSettings.hardness / 100;
                
                const color = this.hexToRgba(this.state.colors.foreground, 1);
                const transparent = this.hexToRgba(this.state.colors.foreground, 0);

                preview.style.width = `${size}px`;
                preview.style.height = `${size}px`;
                preview.style.background = `radial-gradient(circle, ${color} ${hardness * 100}%, ${transparent} 100%)`;
            }

            updateLayersUI() {
                const layersList = document.getElementById('layers-list');
                layersList.innerHTML = '';
                this.state.layers.slice().reverse().forEach(layer => {
                    const el = document.createElement('div');
                    el.className = `layer-item ${layer.id === this.state.currentLayerId ? 'active' : ''}`;
                    el.innerHTML = `<span class="layer-visibility">${layer.visible ? 'üëÅÔ∏è' : 'üö´'}</span><span class="layer-name">${layer.name}</span>`;
                    el.addEventListener('click', () => {
                        this.state.currentLayerId = layer.id;
                        this.updateLayersUI();
                    });
                    el.querySelector('.layer-visibility').addEventListener('click', (e) => {
                        e.stopPropagation();
                        layer.visible = !layer.visible;
                        this.updateLayersUI();
                        this.redrawCanvas();
                    });
                    layersList.appendChild(el);
                });
            }

            redrawCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width / (window.devicePixelRatio || 1), this.canvas.height / (window.devicePixelRatio || 1));
                this.state.layers.forEach(layer => {
                    if (layer.visible && layer.canvas.width > 0 && layer.canvas.height > 0) {
                        this.ctx.drawImage(layer.canvas, 0, 0, this.canvas.width / (window.devicePixelRatio || 1), this.canvas.height / (window.devicePixelRatio || 1));
                    }
                });
            }

            // Utility functions
            hexToRgba(hex, alpha = 1) {
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            rgbaToHex(r, g, b) {
                return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
            }
            showToast(message) {
                const existingToast = document.querySelector('.toast');
                if (existingToast) existingToast.remove();
                
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        let editor;
        window.addEventListener('load', () => {
            editor = new BrushesEditor();
            window.addEventListener('resize', () => {
                editor.resizeCanvas();
                editor.redrawCanvas();
            });
        });
    </script>
</body>
</html>

